---
title: 'Cursory Mathematical Analysis of MYHockey Rankings Algorithm (Part 2)'
date: 2024-02-26
permalink: /posts/2024/02/myhockey2/
tags:
  - cool posts
---

After discussing the MYHockey algorithm with my uncle, I learned that one of the assumptions in my previous analysis is wrong. In particular, the rating associated with the strength of a team's opponents is not computed from static values from a previous time, but they are updated with every game result.

As before, $r$ is the vector of ratings for the different teams and $\Delta$ is the vector whose $i$'th element is the number of goals scored by team $i$ minus it's number of goals yielded. $S$ is the matrix where the element $S_{i,j}$ represents how many times team $j$ played team $i$. Lastly, $n$ is the vector whose $i$'th element is the number of games played by team $i$ (Note that $n=S1$). I now believe that ratings are computed as the solution to the system of equations of the form:

$$
\begin{align}
r&=diag(n)^{-1}\left(\Delta + Sr\right)
\end{align}
$$

In words, the rating of a team is given by the sum of the average goal differential and the average rating of their opponents. This system can be rewritten as:

$$
\begin{align*}
\left( diag(n) - S \right)r &= \Delta
\end{align*}
$$

If the game schedule is interpreted as a weighted graph with edge weights equal to the number of games played between a pair of teams, the matrix on the lefthand side of the above equation is the Laplacian of this graph. Thus, we define $L\triangleq diag(n)-S$ giving:

$$
\begin{align}
Lr=\Delta
\end{align}
$$

Heat equation analogy
----

The Laplacian matrix of a graph can be interpreted as an finite-difference approximation of the negative continuous Laplacian operator [[Smola and Condor, 2003](https://people.cs.uchicago.edu/~risi/papers/SmolaKondor.pdf)]. So, we can draw an analogy between the MYHockey rating system, and the [heat equation](https://en.wikipedia.org/wiki/Heat_equation). The heat equation takes the form:

$$
\begin{align*}
Lu=\frac{\partial u}{\partial t}
\end{align*}
$$

where $u(x,t)$ is a temperature function across space and time, and $L$ is the spatial Laplacian operator. This equation says that the rate of change of temperature at a given location is equal to the spatial Laplacian of temperature at that point. The Laplacian, informally, measures how much a function at a point deviates from its average value in the surrounding neighborhood. So, this equation makes intuitive sense - if the temperature at a point is higher than its surrounding, it will cool over time.

In our ratings system, the temperature function is analagous to the ratings, and the time derivative is analagous to the goal differential. <b>The hockey ratings are the temperatures under which changes in temperature are given by the <i>negative</i> goal differentials</b> (emphasis on the negative). So, if a team is hot (has a high rating) relative to its neighbors (opponents) we expect that it will be cooling (high goal differential). If a team is cold (low rating) relative to its neighbors, we expect it will be heating (negative goal differential).

Existence of solution
--------

The ratings are computed as the solution to equation 2. However, how do we know a solution exists? In fact, the matrix $L$ is not invertible since it has a zero eigenvalue associated with the $1$ vector. Fortunately, results from matrix analysis [[Spielman, 2009](https://cs.yale.edu/homes/spielman/561/2009/lect02-09.pdf)] tell us that:
- Eigenvalues of $L$ are real and non-negative
- If the graph is connected, the second eigenvalue is positive

Thus, the nullspace of $L$ is equal to the span of the $1$ vector. Further, since $L$ is real an symmetric, it can be diagonalized into:

$$
\begin{align*}
L=\begin{bmatrix}
U' | 1
\end{bmatrix}\begin{bmatrix}
D | 0 \\
0, 0
\end{bmatrix}\begin{bmatrix}
U'^T \\
1
\end{bmatrix}
\end{align*}
$$

It is clear from this representation that the range of $L$ is $1^\perp$, i.e. the linear subspace perpendicular to the $1$ vector. Fornately, since goal differentials must sum to zero across all teams, we have $\Delta \cdot 1=0 \implies \Delta \in 1^\perp$. Thus, we can use, for example, the pseudoinverse of $L$ to find a ratings vector that satisfies $Lr=\Delta$. This rating is unique up to a translation by $1$.

In summary: <b>If the game schedule graph is connected (i.e. there is a "path" of games that connects each team to every other team), then there exists a rating vector such that $Lr=\Delta$. </b>

Ratings do not change when goal differences match rating differences
------------
<b>Proof</b>

Consider, without loss of generality, the case where a single game is played between team $i$ and team $j$ and the game differential and score matrix for this game only are represented by $\Delta'$ and $S'$ respectively. Also, diag(n') is the matrix that is completely zero except for a one at positions $(i,i),(j,j)$.

$$
\begin{align}
\left( diag(n) - S_{old} \right)r_{old} &= \Delta_{old} \\
\left( diag(n)+diag(n') - S_{old}-S' \right)r_{new} &= \Delta_{old}+\Delta' \\
\text{Subtract (2) form (3)} \nonumber \\
(diag(n)-S_{old})(r_{new}-r_{old})+(diag(n')-S')r_{new}&= \Delta' 
\end{align}
$$

If we assume that ratings are unchanged, then we can plug in $r_{new}=r_{old}=0$ to Eq. 4 and getgives:

$$
\begin{align*}
(diag(n')-S')r_{old}&= \Delta' \\
r_{old,i}-r_{old,j}&= \Delta'_i 
\end{align*}
$$

which means that ratings are unchanged when goal differences match rating differences. If we re-arrange Eq. 4:

$$
\begin{align}
(diag(n)-S_{old})(r_{new}-r_{old})&= \Delta' - (diag(n')-S')r_{new}
\end{align}
$$

The right hand side clearly has only two nonzero elements

$\blacksquare$