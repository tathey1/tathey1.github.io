---
title: 'Mathematics of MYHockey Rankings'
date: 2024-02-20
permalink: /posts/2024/02/myhockey/
tags:
  - cool posts
---

I recently move to Massachusetts where the youth sport of choice is ice hockey. I was watching my cousin play a game and, between the crashes of body checks into the boards that made me fear for my cousin's life, my uncle told me about a website where he gets his intel on the other teams - [myhockeyrankings.com](https://myhockeyrankings.com/index.php).

From what I can understand, the website was developed about 20 years ago by some hockey parent(s) who wanted to quantitatively compare teams that didn't play each other. According to a [post on their website](https://myhockeyrankings.com/news.php?b=305), each team is given a "Ranking" which is computed to be the sum of their "Sched" score (the average strength of their opponents), and their "AGD" (average goal differential, with a single game differential capped at 7). Some details of their algorithm not clear to me (e.g. Does the Sched score only include opponents that have already been played that season or does it include future opponents? Is the Sched score computed using rankings at the end of last season or are these rankings updated throughout the season?). Nevertheless, I was tempted to do some mathematical analysis.

We will examine how current rankings are computed. We will assume:

- Sched scores only include opponents that have already been played that season
- Sched scores are based on rankings from the previous year.

If there are $D$ teams in a league, let $r \in \mathbb{R}^D$ be the vector of rankings for each of the teams where $r_i$ is the ranking of team $i$:

$$r=\begin{pmatrix}
r_1 \\
r_2 \\
... \\
r_D
\end{pmatrix}$$

We will denote the rankings at the end of the previous year as $r^{(prev)}$.

Then, let $S$ be the matrix that contains schedule information. Element $S_{ij}$ is the number of times that team $i$ played team $j$ this season. As an example, in a league with 4 teams, say team 1 played team 2, and team 3 played team 4. Then, our $S$ matrix is:

$$S=\begin{pmatrix}
0 & 1 & 0 & 0 \\
1 & 0 & 0 & 0 \\
0 & 0 & 0 & 1 \\
0 & 0 & 1 & 0
\end{pmatrix}$$

Next, let $\Delta$ be the vector of goals scored minus goals yielded for each team. For example, if team $i$ scored 5 goals and yielded 2 goals, then $\Delta_i=3$. We will examine this system under a variety of settings, starting with a simple setting.

Setting A) Each team plays $n$ games, no scoring cap
=============================

In this case, the Sched score is given as $\frac{1}{n}Sr^{(prev)}$ and the AGD score is $\frac{1}{n}\Delta$, so the current rankings formula is:

$$
\begin{align*}
r&=\frac{1}{n}(Sr^{(prev)}+\Delta)
\end{align*}
$$

When does a ranking increase or decrease?
--

If we examine the quantity $r - r^{(prev)}$, we get the following formula:

$$
\begin{align}
n*\left(r_i-r_i^{(prev)}\right) &= \Delta_i - \left(\sum_{\text{games played by team }i} r_i^{(prev)} - r_{\text{opponent in game }g}^{(prev)} \right)
\end{align}
$$
Or, in words:
$$
\begin{align*}
n*\text{(ranking change)} &= \text{goal diff} - \left(\sum_{g \in games} \text{ prev. ranking} - \text{rank of opponent} \right)
\end{align*}
$$

<b>Proof:</b>

$$
\begin{align*}
r - r^{(prev)}&=\frac{1}{n}Sr^{(prev)} + \frac{1}{n}\Delta - r^{(prev)} \\
&=(\frac{1}{n}S-I)r^{(prev)} + \frac{1}{n}\Delta \\
n(r - r^{(prev)})&=(S-nI)r^{(prev)} + \Delta
\end{align*}
$$

The $i$'th term in the last line above is given as:

$$
\begin{align*}
n(r_i - r^{(prev)}_i)&=\Delta_i - \left(\sum_{g \in \text{games played by team }i} r^{(prev)}_i-r^{(prev)}_{\text{opponent in game g}}\right) \\
\end{align*}
$$

$\blacksquare$


<i>So a team's ranking will be unchanged if their goal differential is precisely the ranking difference between them and their opponents </i>. If they score more goals than this ranking difference, their ranking will increase, otherwise it will decrease.

Conservation of total ranking
---------------------

Another observation in this setting is that the sum of the rankings remains unchanged

$$\begin{align}
\sum_i r_i=\sum_i r^{(prev)}_i
\end{align}$$

<b>Proof:</b>

First we rewrite $\sum_i r_i$ as $1^Tr$, which is more concise.

$$
\begin{align*}
1^T r&=\frac{1}{n}1^T(Sr^{(prev)}+\Delta) \\
&=\frac{1}{n}(1^TSr^{(prev)}+1^T\Delta) \\
&= \frac{1}{n}(n1^Tr^{(prev)}+0) &\text{Each team plays $n$ games, and the goal differentials sum to 0} \\
&= 1^Tr^{(prev)}
\end{align*}
$$

$\blacksquare$

Setting B) Teams play a variable amount of games, no scoring cap
=======================

In this case, we need to normalize rankings by different numbers $n_i$, the number of games that team $i$ has played. The vector that contains these values is $n$, and we introduce the $diag(\cdot)$ operator, which takes a vector, and produces a corresponding diagonal matrix whose diagonal entries are given by the vector. Our new update rule is: 

$$
\begin{align*}
r&=(diag(n))^{-1}(Sr^{(prev)} + \Delta)
\end{align*}
$$

Note that $n=S1$ where $1$ is the vector of all 1's.

It turns out that the rule for whether a ranking increases/decreases is the same, it is related to whether a team's goal differential is more or less than its cumulative ranking differential.

$$
\begin{align}
n_i(r_i-r_i^{(prev)})&=\Delta_i - \left(\sum_{g \in \text{games played by team }i} r^{(prev)}_i-r^{(prev)}_{\text{opponent in game g}}\right) \\
\end{align}
$$

However, the sum of the rankings is no longer conserved, instead a different quantity is conserved:

$$n \cdot r = n \cdot r^{(prev)}$$

Example where ranking sum is not conserved
-----------------

$$
\begin{align*}
r^{(prev)} &= \begin{pmatrix} 1 \\ 0 \\ 0 \\ -1
\end{pmatrix}, 
S &= \begin{pmatrix} 0 & 1 & 1 & 1 \\
1 & 0 & 0 & 0 \\
1 & 0 & 0 & 1 \\
1 & 0 & 1 & 0
\end{pmatrix},
\Delta &= \begin{pmatrix} 2 \\ -1 \\ 1 \\ -2
\end{pmatrix}
\end{align*}
$$

i.e. Team 1 beat team 2 and 4 1-0 and tied team 3, and team 3 beat team 4 1-0. Note that the previous rankings add up to 0.

The new rankings are:

$$
\begin{align*}
r &= \begin{pmatrix} 1/3 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 0 & 1/2 & 0 \\
0 & 0 & 0 & 1/2
\end{pmatrix} \left(
  \begin{pmatrix} 0 & 1 & 1 & 1 \\
1 & 0 & 0 & 0 \\
1 & 0 & 0 & 1 \\
1 & 0 & 1 & 0
\end{pmatrix}
\begin{pmatrix} 1 \\ 0 \\ 0 \\ -1
\end{pmatrix} + 
\begin{pmatrix} 2 \\ -1 \\ 1 \\ -2
\end{pmatrix}
 \right) \\
 &= \begin{pmatrix} 1/3 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 0 & 1/2 & 0 \\
0 & 0 & 0 & 1/2
\end{pmatrix} \left(
\begin{pmatrix} -1 \\ 1 \\ 0 \\ 1
\end{pmatrix} + 
\begin{pmatrix} 2 \\ -1 \\ 1 \\ -2
\end{pmatrix}
 \right) \\
 &= \begin{pmatrix} 1/3 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 0 & 1/2 & 0 \\
0 & 0 & 0 & 1/2
\end{pmatrix} 
\begin{pmatrix} 1 \\ 0 \\ 1 \\ -1
\end{pmatrix} \\
&= 
\begin{pmatrix} 1/3 \\ 0 \\ 1/2 \\ -1/2
\end{pmatrix}
\end{align*}
$$

The new rankings no longer add to zero.

Setting C) Score differential capped at 7
========================

In this case, AGD is no longer simply the difference between goals scored and goals yielded because this quantity can only take a maximum value of 7 per game. Instead, we need to define new variables

$$
\delta_g = \text{goals scored in game g} - \text{goals yielded in game g}\\
\tilde \Delta_i = \sum_{g \in \text{games played by team }i} t_7(\delta_g) 
$$

where $t_\theta(\delta_g)$ is the truncated identity function, i.e. it is the identity when $\vert \delta_g \vert < \theta$ and equal to $-\theta$ when $\delta_g < -\theta$ and $\theta$ when $\delta_g > \theta$.

Our update rule becomes:

$$
\begin{align*}
r&=(diag(n))^{-1}(Sr^{(prev)} + \tilde \Delta)
\end{align*}
$$


The change in ranking for team $i$ is:

$$
\begin{align}
n_i(r_i-r_i^{(prev)})&=\tilde \Delta_i - \left(\sum_{g \in \text{games played by team }i} r^{(prev)}_i-r^{(prev)}_{\text{opponent in game g}}\right) \nonumber \\
&= \sum_{g \in \text{games played by team }i} \left(t_7(\delta_g) - \left(r^{(prev)}_i-r^{(prev)}_{\text{opponent in game g}}\right) \right)
\end{align}
$$

The rule for whether your ranking will increase or decrease is the same as before, except in the case of ranking differentials greater than 7. In this case, <i>when a team is ranked more than 7 points above its opponent, the game result is guaranteed to lower the ranking of the higher ranked team, and raise the ranking of the lower ranked team. </i>

Result needed for team $i$ to surpass team $j$
--------------

Say team $i$ is playing a game and needs to achieve ranking higher than $r_j$. What is the score differential $\delta$ they need to achieve? First assume that team $i$ is not playing team $j$, and say that we know the current ranking of team $i$ as $r_i^{(cur)}$. If team $i$ wants to be ranked above team $j$ after their game, then they must achieve a differential $\delta$ that satisfies:

$$
\begin{align}
t_7(\delta) > n_i \left(r_j - r_i^{(cur)} \right) - r^{(prev)}_{\text{opponent}} + r_i^{(cur)}
\end{align}
$$

<b>Proof:</b>

Recall that

$$
(n_i-1)r_i^{(cur)}=\sum_{g \in \text{previous games played by team }i} \left(t_7(\delta_g) + r^{(prev)}_{\text{opponent in game g}} \right)
$$

Now,

$$
\begin{align*}
r_j&\lt \frac{1}{n_i}\left( t_7(\delta) +r^{(prev)}_{\text{opponent}}+(n_i-1)r_i^{(cur)} \right)\\
t_7(\delta) &\gt n_i r_j -r^{(prev)}_{\text{opponent}} - (n_i-1)r_i^{(cur)} \\
&= n_i \left(r_j - r_i^{(cur)} \right) - r^{(prev)}_{\text{opponent}} + r_i^{(cur)}
\end{align*}
$$

$\blacksquare$

If the value on the right hand side is greater than 7, it is impossible for team $i$ to surpass team $j$ after this game. If it is less than -7, than team $i$ is guaranteed to remain ahead of team $j$. When the right hand side is between -7 and 7, team $i$ needs to achieve a minimum goal differential $\delta$. This goal differential increases when (all other things being equal):

- The number of games team $i$ has played is increased
- The current ranking difference between team $j$ and team $i$ is increased
- The current ranking of team $i$ is decreased
- The ranking of the opponent is decreased

Now, say team $i$ is playing team $j$. Then if team $i$ wants to be ranked above team $j$ after their game, then they must achieve a differential $\delta$ that satisfies:

$$
\begin{align}
t_7(\delta)> \frac{n_ir^{(prev)}_{i} - n_j r^{(prev)}_{j} + n_i(n_j-1)r_j^{(cur)} - n_j(n_i-1)r_i^{(cur)}}{\left(n_j+n_i\right)}
\end{align}
$$

<b>Proof:</b>
$$
\begin{align*}
r_i &> r_j \\
\frac{1}{n_i}\left( t_7(\delta) +r^{(prev)}_{j}+(n_i-1)r_i^{(cur)} \right) &> \frac{1}{n_j}\left( -t_7(\delta) +r^{(prev)}_{i}+(n_j-1)r_j^{(cur)} \right) \\
t_7(\delta) &> \frac{n_i}{n_j}\left( -t_7(\delta) +r^{(prev)}_{i}+(n_j-1)r_j^{(cur)} \right) -r^{(prev)}_{j}-(n_i-1)r_i^{(cur)} \\
t_7(\delta) \left(1+\frac{n_i}{n_j}\right)&>  \frac{n_i}{n_j}\left( r^{(prev)}_{i}+(n_j-1)r_j^{(cur)} \right) -r^{(prev)}_{j}-(n_i-1)r_i^{(cur)} \\
t_7(\delta) &> \frac{\frac{n_i}{n_j}r^{(prev)}_{i} - r^{(prev)}_{j} + \frac{n_i}{n_j}(n_j-1)r_j^{(cur)} - (n_i-1)r_i^{(cur)}}{\left(1+\frac{n_i}{n_j}\right)} \\
 &= \frac{n_ir^{(prev)}_{i} - n_j r^{(prev)}_{j} + n_i(n_j-1)r_j^{(cur)} - n_j(n_i-1)r_i^{(cur)}}{\left(n_j+n_i\right)}
\end{align*}
$$

$\blacksquare$

If the value on the right hand side is greater than 7, it is impossible for team $i$ to surpass team $j$ after this game. If it is less than -7, than team $i$ is guaranteed to remain ahead of team $j$. When the right hand side is between -7 and 7, things the goal differential needed increases when:

- The team's previous ranking is increased
- The opponent's previous ranking is decreased
- The opponent's current ranking is increased
- The team's current ranking is decreased

The dependence on $n_i$ and $n_j$ is more complex.

<img src="/images/myhockey/fig.png"/>

Empirically, when $r_i^{(cur)}>r_j^{(cur)}$, the team only needs to win in order to preserve their higher ranking. When $r_i^{(cur)}<r_j^{(cur)}$, the goal differential needed increases when (all other things being equal):

- Team $i$'s number of games played ($n_i$) is increased
- The opponent's number of games played ($n_j$) is increased
- The opponent's current ranking is increased

When the current rankings are equal, the difference between last year's rankings and the current rankings matters. Even if the previous and current rankings of the teams are the same, if both teams have gotten worse, the team with more games needs to win, in order to counteract their longer slump.

Discussion
======

Recall that I made a couple assumptions about how the score of the schedule is computed. In particular, I assumed that the schedule score is computed from last year's rankings, and only includes the games that a team has already played this season. This analysis will not necessarily hold up if those assumptions are not true.

However, under these assumptions we showed that:

- For a game with a ranking differential less than 7, if the goal differential is equal to the ranking differential, the teams' rankings will not change (Equations 1,3,4).
- If all teams play the same number of games, the sum of their rankings remains unchanged (Equation 2), but this is not the case if teams play a different number of games.
- When a team wants a result to put them ahead of another team, the required game differential depends on the number of games they played, their and their opponent's ranking from the previous year, and their current ranking (Equation 5). If they are playing the team they want to surpass, then it also depends on their opponents current ranking, and the number of games their opponent has played (Equation 6).

Now that I have beat this problem into the ground, I think it's time to return to my actual work.